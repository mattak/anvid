#!/bin/bash -e

# This Line is Automatically setted by server.
APP_URL=http://localhost:1028

if [ -z "$(which adb)" ]; then
    echo "Not found adb. Install and add PATH to it."
    exit 1
fi

_DEVICE_COUNT=$(adb devices  | grep device | grep -v "List of devices attached" | wc -l | xargs echo)

if [ $_DEVICE_COUNT -lt 1 ]; then
    echo "No device"
    exit 1
fi

if [ $_DEVICE_COUNT -gt 1 ]; then
    echo "More than two device. Not supported now."
    exit 1
fi

# Note: perl is for newline chomp.
_DEVICE_SDK_VERSION_CODE=$(adb shell getprop ro.build.version.sdk | perl -ne 'printf "%d", $_')
_DEVICE_SDK_VERSION_NAME=$(adb shell getprop ro.build.version.release | perl -ne 'printf "%s", $_')
_DEVICE_PRODUCT_BOARD=$(adb shell getprop ro.product.board | perl -ne 'printf "%s", $_')
_DEVICE_PRODUCT_BRAND=$(adb shell getprop ro.product.brand | perl -ne 'printf "%s", $_')
_DEVICE_PRODUCT_MDOEL=$(adb shell getprop ro.product.model | perl -ne 'printf "%s", $_')

if [ $_DEVICE_SDK_VERSION_CODE -lt 20 ]; then
    echo "API LEVEL should be greater then 20. you are ${_DEVICE_SDK_VERSION_CODE}."
    exit 1
fi

_TMP_ANDROID_FILE=/sdcard/tmp.mp4
_TMP_PC_FILE=/tmp/tmp.mp4

_TTY=$(tty | sed 's#^/dev/##')
_TPGID=$(ps h -t ttys002 -o tpgid | tail -n +2 | uniq)

function copy_and_upload() {
    # It's very impotant to wait screenrecord saving file.
    sleep 1
    adb pull $_TMP_ANDROID_FILE $_TMP_PC_FILE 1>&2
    sleep 0.1
    # adb shell rm $_TMP_ANDROID_FILE
    sleep 0.1
    curl -X POST -F file=@$_TMP_PC_FILE $APP_URL/upload
    sleep 0.1
}

# wait SIGINT. when you type Ctrl+C it sent movie.
trap "copy_and_upload" 2

adb shell screenrecord $_TMP_ANDROID_FILE
